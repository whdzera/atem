name: Discord Commit Notify

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMITS=$(jq -r '.commits[] | "- [`\(.id[0:7])`](\(.url)) \(.message) — *\(.author.name)*"' "$GITHUB_EVENT_PATH")

          payload=$(jq -n \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg branch "${GITHUB_REF##*/}" \
            --arg actor "$GITHUB_ACTOR" \
            --arg commits "$COMMITS" \
            '{
              embeds: [
                {
                  title: "New push to \($branch)",
                  description: $commits,
                  color: 5814783,
                  fields: [
                    {
                      name: "Repository",
                      value: $repo,
                      inline: true
                    },
                    {
                      name: "Pushed by",
                      value: $actor,
                      inline: true
                    }
                  ],
                  footer: {
                    text: "GitHub → Discord"
                  }
                }
              ]
            }')

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK"
